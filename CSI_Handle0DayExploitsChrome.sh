#!/bin/bash

# LH - Christmas 2019 - Download latest Chrome in case of Exploit.
# Use when count is of Old version is high
# Which means the auto updater isn't working ok.
# Later, an internal URL can be added to CURL

DOWNLOAD_URL="https://dl.google.com/chrome/mac/stable/GGRO/googlechrome.dmg"
DMG_PATH="/tmp/Google Chrome.dmg"
DMG_VOLUME_PATH="/Volumes/Google Chrome"
APP_NAME="Google Chrome.app"
APP_PATH="/Applications/$APP_NAME"
APP_PROCESS_NAME="Google Chrome"
APP_INFO_PLIST="Contents/Info.plist"
APP_VERSION_KEY="CFBundleShortVersionString"
APP_PERMISSION_USER="root"
APP_PERMISSION_GROUP="wheel"
BINARY_CHROME="/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome"

if pgrep "$APP_PROCESS_NAME" &>/dev/null; 
	then
 		printf "Error - %s is currently running!" "$APP_PROCESS_NAME"
 		sleep 2
		#killall 'Google Chrome'
		osascript -e 'quit app "Google Chrome"'
		sleep 2
		echo "Quitting done."
		rm -Rf "$APP_PATH"
		echo "It's suggested to delete the unwanted app."
fi
curl --retry 3 -L "$DOWNLOAD_URL" -o "$DMG_PATH"
hdiutil attach -nobrowse -quiet "$DMG_PATH"
version=$(defaults read "$DMG_VOLUME_PATH/$APP_NAME/$APP_INFO_PLIST" "$APP_VERSION_KEY")
printf "Installing $APP_PROCESS_NAME version %s" "$version"
ditto -rsrc "$DMG_VOLUME_PATH/$APP_NAME" "$APP_PATH"
chown -R "$APP_PERMISSION_USER":"$APP_PERMISSION_GROUP" "$APP_PATH"
hdiutil detach -quiet "$DMG_VOLUME_PATH"
rm "$DMG_PATH"
sleep 2

# Love Thy Users #
# Try to Restore the Tabs. Just one attempt, okay?
currentuser=`stat -f "%Su" /dev/console`
# This works better if you grep the console user
# Then run it as the user
su "$currentuser" -c "$BINARY_CHROME" -restore-last-session

exit 0